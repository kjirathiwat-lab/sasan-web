import { GoogleGenerativeAI } from "@google/generative-ai";

// ตรวจสอบ API Key
const apiKey = process.env.GEMINI_API_KEY;
if (!apiKey) {
  console.warn("⚠️ GEMINI_API_KEY not found in environment variables");
}

const genAI = apiKey ? new GoogleGenerativeAI(apiKey) : null;

// ============================================================
// Knowledge Base - ข้อมูลทั้งหมดของ SASAN
// ============================================================
const SASAN_KNOWLEDGE = `
คุณเป็น "น้องสาน" ผู้ช่วย AI ของ SASAN บริการจัดงานศพครบวงจร
ตอบสั้นๆ กระชับ เป็นมิตร อบอุ่น ใช้ภาษาไทย ใส่ emoji บ้างเล็กน้อย

══════════════════════════════════════
ข้อมูลบริษัท SASAN (สะ-สาน)
══════════════════════════════════════
• โทรศัพท์: 081-234-5678 (24 ชั่วโมง)
• LINE: @sasan
• ประสบการณ์: 15+ ปี
• งานที่ดูแล: 1,000+ งาน
• วัดพันธมิตร: 50+ แห่ง
• ความพึงพอใจ: 98%

══════════════════════════════════════
แพ็คเกจบริการ
══════════════════════════════════════

📘 The Memoir (เดอะ เมมัวร์) - ความทรงจำอันอบอุ่น
• ราคา: ฿45,000 - ฿55,000
• ระยะเวลา: 3 วัน
• รองรับ: 30-80 คน/วัน
• เหมาะกับ: งานขนาดเล็ก วัดขนาดเล็ก

📗 The Narrative (เดอะ แนร์ราทีฟ) - บอกเล่าเรื่องราว ⭐ POPULAR
• ราคา: ฿65,000 - ฿85,000
• ระยะเวลา: 5 วัน
• รองรับ: 80-150 คน/วัน
• เหมาะกับ: งานขนาดกลาง

📙 The Legacy (เดอะ เลกาซี) - มรดกแห่งความทรงจำ ⭐ BEST VALUE
• ราคา: ฿95,000 - ฿120,000
• ระยะเวลา: 5 วัน
• รองรับ: 150-300 คน/วัน
• เหมาะกับ: งานขนาดใหญ่

📕 The Masterpiece (เดอะ มาสเตอร์พีช) - ผลงานชิ้นเอก ⭐ PREMIUM
• ราคา: ฿150,000 ขึ้นไป
• ระยะเวลา: 7 วัน
• รองรับ: 300+ คน/วัน
• เหมาะกับ: งานระดับ VIP

══════════════════════════════════════
ทุกแพ็คเกจรวม
══════════════════════════════════════
✅ ค่าเช่าศาลา
✅ ค่าเมรุและฌาปนกิจ
✅ ดอกไม้ตกแต่งหน้างาน
✅ ธูปเทียน
✅ น้ำดื่ม-ขนม-กาแฟ
✅ โลงศพ
✅ รถรับศพ
✅ ของชำร่วย
✅ ดอกไม้จันทน์
✅ ทีมงานดูแลตลอดงาน

══════════════════════════════════════
โปรโมชั่น
══════════════════════════════════════
🎁 จองล่วงหน้า 30 วัน: ลด 5%
🎁 จองล่วงหน้า 60 วัน: ลด 10%

══════════════════════════════════════
บริการเสริม
══════════════════════════════════════
• พิธีทางศาสนาพุทธ/คริสต์/อิสลาม
• ถ่ายภาพ-วิดีโอ
• ลอยอังคาร
• จัดเลี้ยง
• รถรับส่งแขก
• ช่อดอกไม้หน้าศพ

══════════════════════════════════════
ขั้นตอนการทำงาน
══════════════════════════════════════
1. ติดต่อปรึกษา (ทันที 24 ชม.)
2. วางแผนร่วมกัน (1-2 ชม.)
3. เตรียมงาน (1-3 วัน)
4. ดำเนินพิธี (3-7 วัน)
5. ดูแลหลังงาน

══════════════════════════════════════
หมายเหตุสำคัญ
══════════════════════════════════════
• ถ้าลูกค้าถามนอกเหนือจากข้อมูลนี้ ให้แนะนำติดต่อเจ้าหน้าที่โดยตรง
• ถ้าลูกค้าต้องการจอง ให้แนะนำโทรหรือ LINE
• ตอบอย่างเห็นอกเห็นใจ เข้าใจว่าลูกค้าอาจอยู่ในช่วงเวลาที่ยากลำบาก
`;

// ============================================================
// Chat Function
// ============================================================
export async function chatWithGemini(userMessage: string): Promise<string> {
  // ถ้าไม่มี API Key ให้ตอบแบบ fallback
  if (!genAI) {
    return getFallbackResponse(userMessage);
  }

  try {
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

    const prompt = `${SASAN_KNOWLEDGE}

══════════════════════════════════════
ลูกค้าถาม: ${userMessage}
══════════════════════════════════════

ตอบ (สั้นๆ กระชับ เป็นมิตร):`;

    const result = await model.generateContent(prompt);
    const response = result.response.text();
    
    return response || "ขออภัยค่ะ ไม่สามารถตอบได้ในขณะนี้ กรุณาโทร 081-234-5678 🙏";
    
  } catch (error) {
    console.error("Gemini API Error:", error);
    return getFallbackResponse(userMessage);
  }
}

// ============================================================
// Fallback Response - ถ้า AI ไม่ทำงาน
// ============================================================
function getFallbackResponse(message: string): string {
  const lowerMessage = message.toLowerCase();
  
  // ตรวจจับคำสำคัญ
  if (lowerMessage.includes("ราคา") || lowerMessage.includes("เท่าไหร่") || lowerMessage.includes("แพง")) {
    return "💰 แพ็คเกจของเราเริ่มต้นที่ ฿45,000 ค่ะ\n\n📘 The Memoir: ฿45,000-55,000\n📗 The Narrative: ฿65,000-85,000\n📙 The Legacy: ฿95,000-120,000\n📕 The Masterpiece: ฿150,000+\n\nต้องการรายละเอียดเพิ่มเติม โทร 081-234-5678 ค่ะ 🙏";
  }
  
  if (lowerMessage.includes("แพ็ค") || lowerMessage.includes("package") || lowerMessage.includes("บริการ")) {
    return "📦 SASAN มี 4 แพ็คเกจให้เลือกค่ะ:\n\n1. The Memoir - งานเล็ก 3 วัน\n2. The Narrative - งานกลาง 5 วัน ⭐\n3. The Legacy - งานใหญ่ 5 วัน\n4. The Masterpiece - งาน VIP 7 วัน\n\nสนใจแพ็คเกจไหนคะ? 😊";
  }
  
  if (lowerMessage.includes("โทร") || lowerMessage.includes("ติดต่อ") || lowerMessage.includes("เบอร์")) {
    return "📞 ติดต่อเราได้ 24 ชั่วโมงค่ะ!\n\n☎️ โทร: 081-234-5678\n💚 LINE: @sasan\n\nทีมงานพร้อมให้คำปรึกษาฟรีค่ะ 🙏";
  }
  
  if (lowerMessage.includes("line") || lowerMessage.includes("ไลน์")) {
    return "💚 LINE ID: @sasan\n\nแอดไลน์มาได้เลยค่ะ ทีมงานพร้อมให้บริการ 24 ชม. 🙏";
  }
  
  if (lowerMessage.includes("สวัสดี") || lowerMessage.includes("หวัดดี") || lowerMessage.includes("hello")) {
    return "สวัสดีค่ะ 🙏 ยินดีต้อนรับสู่ SASAN\n\nดิฉันชื่อน้องสาน พร้อมให้คำปรึกษาเรื่องจัดงานศพค่ะ\n\nมีอะไรให้ช่วยไหมคะ? 😊";
  }
  
  // Default response
  return "ขอบคุณที่ติดต่อ SASAN ค่ะ 🙏\n\nสำหรับคำถามเพิ่มเติม กรุณาติดต่อเจ้าหน้าที่โดยตรง:\n\n📞 โทร: 081-234-5678\n💚 LINE: @sasan\n\nพร้อมให้บริการ 24 ชั่วโมงค่ะ 😊";
}
